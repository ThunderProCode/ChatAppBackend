<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <link rel="stylesheet" href="./styles.css">
  </head>
  <body>
    <div class="chat-window">
      <div class="info-bar">
        <h2 id="my-username">Username:</h2>
        <form class="connection-form" id="connection-form" action="">
          <input class="connection-input" id="connection-username" autocomplete="off" />
          <button type="button" class="connection-button" onclick="connect()" >Connect</button>
        </form>
      </div>
      <ul id="messages"></ul>
      <form id="form" action="">
        <input id="input" autocomplete="off" />
        <button>Send</button>
      </form>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();

        var messages = document.getElementById('messages');
        var form = document.getElementById('form');
        var input = document.getElementById('input');

        let connected = false;
        let targetUserID;

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (input.value) {
              if(connected && targetUserID){
                socket.emit('chat message', {to:targetUserID,message:input.value});
                var item = document.createElement('li');
                item.textContent = input.value;
                messages.appendChild(item);
                input.value = '';
              }
            }
        });

        socket.on('chat message', function(msg) {
            var item = document.createElement('li');
            item.textContent = msg;
            messages.appendChild(item);
            window.scrollTo(0, document.body.scrollHeight);
        });

        socket.on('username', function(username){
            document.getElementById("my-username").innerText = "Username: " + username;
        });

        socket.on('connected', (connectionId) => {
          console.log(`Connected to: ${connectionId}`);
          connected = true;
          targetUserID = connectionId;
        });

        function connect() {
          const connectionUsername = document.getElementById("connection-username").value;
          socket.emit('connection-username',connectionUsername);
        }

    </script>

  </body>
</html>